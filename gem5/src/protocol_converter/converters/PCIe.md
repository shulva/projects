# PCIe TLP 事务类型完全指南

## 1. PCIe TLP 概述
PCI Express (PCIe) 使用事务层包(TLP)在设备间通信。TLP由以下部分组成：
- **Header** (3或4 DW)：定义事务类型和属性
- **Data Payload** (可选)：0-N DW
- **TLP Digest** (可选)：1 DW ECRC

## 2. TLP Header 结构

### 通用Header首DW (DW0)
31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16
┌─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┐
│ FMT │ TYPE│ Reserved │ TC │ Reserved │ TD │ EP │ Attr │ Length (10 bits) │
└─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┘


## 3. PCIe事务类型完整列表

### 3.1 内存事务
| FMT | TYPE | 名称 | 方向 | 描述 |
|-----|------|------|------|------|
| 00  | 0000 | Memory Read (MRd) | 请求 | 32位地址内存读 |
| 01  | 0000 | Memory Read (MRd) | 请求 | 64位地址内存读 |
| 00  | 0001 | Memory Read Lock (MRdLk) | 请求 | 带锁定的内存读 |
| 01  | 0001 | Memory Read Lock (MRdLk) | 请求 | 64位地址带锁定读 |
| 10  | 0000 | Memory Write (MWr) | 请求 | 32位地址内存写 |
| 11  | 0000 | Memory Write (MWr) | 请求 | 64位地址内存写 |
| 00  | 0110 | FetchAdd (MFA) | 请求 | 原子Fetch-and-Add |
| 01  | 0110 | FetchAdd (MFA) | 请求 | 64位地址Fetch-and-Add |
| 00  | 0111 | Swap (MSwap) | 请求 | 原子Swap操作 |
| 01  | 0111 | Swap (MSwap) | 请求 | 64位地址Swap |
| 00  | 1000 | CAS (MCAS) | 请求 | Compare-and-Swap |
| 01  | 1000 | CAS (MCAS) | 请求 | 64位地址CAS |

### 3.2 I/O事务
| FMT | TYPE | 名称 | 方向 | 描述 |
|-----|------|------|------|------|
| 00  | 0010 | I/O Read (IORd) | 请求 | I/O空间读 |
| 10  | 0011 | I/O Write (IOWr) | 请求 | I/O空间写 |

### 3.3 配置事务
| FMT | TYPE | 名称 | 方向 | 描述 |
|-----|------|------|------|------|
| 00  | 0100 | Config Read (CfgRd0) | 请求 | Type 0配置读 |
| 00  | 0101 | Config Write (CfgWr0) | 请求 | Type 0配置写 |
| 01  | 0100 | Config Read (CfgRd1) | 请求 | Type 1配置读 |
| 01  | 0101 | Config Write (CfgWr1) | 请求 | Type 1配置写 |

### 3.4 消息事务
| FMT | TYPE | 名称 | 方向 | 描述 |
|-----|------|------|------|------|
| 01  | 1rrr | Message (Msg) | 请求 | 基本消息 |
| 11  | 1rrr | Message with Data (MsgD) | 请求 | 带数据的消息 |
| 00  | 1010 | Completion (Cpl) | 响应 | 无数据完成 |
| 10  | 1010 | Completion with Data (CplD) | 响应 | 带数据完成 |
| 01  | 1011 | Completion Locked (CplLk) | 响应 | 锁定完成 |
| 11  | 1011 | Completion Data Locked (CplDLk) | 响应 | 带数据锁定完成 |

## 4. 事务类型编码详解

### 4.1 FMT字段编码
| FMT | 含义 |
|-----|------|
| 00  | 3DW头，无数据 |
| 01  | 4DW头，无数据 |
| 10  | 3DW头，有数据 |
| 11  | 4DW头，有数据 |

### 4.2 TYPE字段编码
| TYPE | 事务类型 |
|------|----------|
| 0000 | 内存读/写 |
| 0001 | 内存读锁定 |
| 0010 | I/O读 |
| 0011 | I/O写 |
| 0100 | 配置读 |
| 0101 | 配置写 |
| 0110 | 内存原子操作 |
| 0111 | 内存原子操作 |
| 1000 | 内存原子操作 |
| 1010 | 完成 |
| 1011 | 锁定完成 |
| 1rrr | 消息 |

## 5. 典型TLP示例

### 5.1 内存读请求 (MRd)
Header DW0:
31 24 23 16 15 8 7 0
┌─────────┬─────────┬─────────┬─────────┐
│ FMT=00 │ TYPE=00 │ TC=0 │ Attr/Len │
├─────────┼─────────┼─────────┼─────────┤
│ Requester ID (16b) │ Tag (8b) │ Last DW BE │
├─────────┼─────────┼─────────┼─────────┤
│ 32-bit Address (DW1) │
└─────────┴─────────┴─────────┴─────────┘


### 5.2 内存写请求 (MWr)
Header DW0:
31 24 23 16 15 8 7 0
┌─────────┬─────────┬─────────┬─────────┐
│ FMT=10 │ TYPE=00 │ TC=0 │ Attr/Len │
├─────────┼─────────┼─────────┼─────────┤
│ Requester ID (16b) │ Tag (8b) │ First DW BE │
├─────────┼─────────┼─────────┼─────────┤
│ 32-bit Address (DW1) │
├─────────┼─────────┼─────────┼─────────┤
│ Data Payload (DW2...) │
└─────────┴─────────┴─────────┴─────────┘


## 6. 总结
PCIe通过丰富的事务类型支持多种通信场景，从传统的内存/I/O访问到高级的原子操作和消息传递。理解这些事务类型对于PCIe设备开发和调试至关重要。