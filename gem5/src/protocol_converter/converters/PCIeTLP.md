# PCIe TLP 格式完全解析

## 1. TLP 基础结构
所有TLP包含三个可选部分：
┌───────────┬──────────────┬───────────┐
│ Header │ Data Payload │ TLP Digest │
│ (3或4 DW) │ (0-N DW) │ (1 DW) │
└───────────┴──────────────┴───────────┘


## 2. TLP Header 详细格式

### 2.1 通用Header字段
所有TLP Header都包含以下字段：

| 字段名     | 位置   | 宽度 | 描述                                                                 |
|------------|--------|------|----------------------------------------------------------------------|
| FMT        | DW0[30:29] | 2b   | 包头格式和数据指示                                                   |
| TYPE       | DW0[28:24] | 5b   | 事务类型                                                            |
| TC         | DW0[22:20] | 3b   | 流量类别(Traffic Class)                                             |
| TD         | DW0[15]    | 1b   | TLP Digest存在标志                                                   |
| EP         | DW0[14]    | 1b   | 错误标记(Error Poisoned)                                            |
| Attr       | DW0[13:12] | 2b   | 属性(缓存一致性、排序等)                                            |
| Length     | DW0[9:0]   | 10b  | 数据载荷长度(以DW计)                                                |

## 3. 主要TLP格式分类

### 3.1 内存请求TLP

#### 32位地址内存读(MRd)
DW0:
31 24 23 16 15 8 7 0
┌─────────┬─────────┬─────────┬─────────┐
│ FMT=00 │ TYPE=00 │ TC/Attr │ Length │
├─────────┼─────────┼─────────┼─────────┤
│ Requester ID │ Tag │ Last DW BE │
├─────────┼─────────┼─────────┼─────────┤
│ 32-bit Address (DW aligned) │
└─────────┴─────────┴─────────┴─────────┘


#### 64位地址内存写(MWr)
DW0:
31 24 23 16 15 8 7 0
┌─────────┬─────────┬─────────┬─────────┐
│ FMT=11 │ TYPE=00 │ TC/Attr │ Length │
├─────────┼─────────┼─────────┼─────────┤
│ Requester ID │ Tag │ First DW BE │
├─────────┼─────────┼─────────┼─────────┤
│ 64-bit Address [31:0] │
├─────────┼─────────┼─────────┼─────────┤
│ 64-bit Address [63:32] │
├─────────┼─────────┼─────────┼─────────┤
│ Data Payload (DW4...) │
└─────────┴─────────┴─────────┴─────────┘


### 3.2 配置请求TLP

#### Type 0配置读(CfgRd0)
DW0:
31 24 23 16 15 8 7 0
┌─────────┬─────────┬─────────┬─────────┐
│ FMT=00 │ TYPE=01 │ TC/Attr │ Length │
├─────────┼─────────┼─────────┼─────────┤
│ Requester ID │ Tag │ Reserved │
├─────────┼─────────┼─────────┼─────────┤
│ Bus/Dev/Func/Reg │ Ext Reg │
└─────────┴─────────┴─────────┴─────────┘


### 3.3 完成TLP

#### 带数据完成(CplD)
DW0:
31 24 23 16 15 8 7 0
┌─────────┬─────────┬─────────┬─────────┐
│ FMT=10 │ TYPE=10 │ TC/Attr │ Length │
├─────────┼─────────┼─────────┼─────────┤
│ Completer ID │ Status │ BCM │
├─────────┼─────────┼─────────┼─────────┤
│ Requester ID │ Tag │ Lower Address │
├─────────┼─────────┼─────────┼─────────┤
│ Data Payload (DW3...) │
└─────────┴─────────┴─────────┴─────────┘


### 3.4 消息TLP

#### 带数据消息(MsgD)
DW0:
31 24 23 16 15 8 7 0
┌─────────┬─────────┬─────────┬─────────┐
│ FMT=11 │ TYPE=1rr│ TC/Attr │ Length │
├─────────┼─────────┼─────────┼─────────┤
│ Requester ID │ Tag │ Msg Code │
├─────────┼─────────┼─────────┼─────────┤
│ Message Routing Info │
├─────────┼─────────┼─────────┼─────────┤
│ Data Payload (DW3...) │
└─────────┴─────────┴─────────┴─────────┘


## 4. TLP格式关键点

### 4.1 FMT字段组合
| FMT[1:0] | 头大小 | 数据 | 典型用途 |
|----------|--------|------|----------|
| 00       | 3DW    | 无   | MRd, CfgRd |
| 01       | 4DW    | 无   | 64位地址MRd |
| 10       | 3DW    | 有   | MWr(32位), CplD |
| 11       | 4DW    | 有   | MWr(64位), MsgD |

### 4.2 地址对齐规则
- 内存TLP地址必须DW对齐(低2位=0)
- 完成TLP使用字节级地址(Lower Address字段)

### 4.3 字节使能(Byte Enable)
- First DW BE：写请求第一个DW的字节使能
- Last DW BE：读请求最后一个DW的字节使能

## 5. 特殊TLP格式

### 5.1 原子操作TLP(PCIe 4.0+)
DW0:
31 24 23 16 15 8 7 0
┌─────────┬─────────┬─────────┬─────────┐
│ FMT=01 │ TYPE=011│ TC/Attr │ Length │
├─────────┼─────────┼─────────┼─────────┤
│ Requester ID │ Tag │ Opcode │
├─────────┼─────────┼─────────┼─────────┤
│ 64-bit Address [31:0] │
├─────────┼─────────┼─────────┼─────────┤
│ 64-bit Address [63:32] │
├─────────┼─────────┼─────────┼─────────┤
│ Compare Data (DW4-5) │
├─────────┼─────────┼─────────┼─────────┤
│ Swap Data (DW6-7) │
└─────────┴─────────┴─────────┴─────────┘


## 6. 总结表

| TLP类型       | 头大小 | 数据 | 地址位宽 | 典型用途 |
|---------------|--------|------|----------|----------|
| MRd32         | 3DW    | 无   | 32位     | 内存读   |
| MRd64         | 4DW    | 无   | 64位     | 内存读   |
| MWr32         | 3DW    | 有   | 32位     | 内存写   |
| MWr64         | 4DW    | 有   | 64位     | 内存写   |
| CfgRd/CfgWr   | 3DW    | 无   | -        | 配置访问 |
| CplD          | 3DW    | 有   | -        | 读完成   |
| Msg/MsgD      | 4DW    | 可选 | -        | 消息传递 |
| AtomicOp      | 4DW    | 有   | 64位     | 原子操作 |
